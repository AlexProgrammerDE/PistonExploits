/*
 * #%L
 * PistonExploits
 * %%
 * Copyright (C) 2021 AlexProgrammerDE
 * %%
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public
 * License along with this program.  If not, see
 * <http://www.gnu.org/licenses/gpl-3.0.html>.
 * #L%
 */
package net.pistonmaster.pistonexploits.utils;

import com.amihaiemil.eoyaml.Yaml;
import com.amihaiemil.eoyaml.YamlMapping;
import com.amihaiemil.eoyaml.extensions.MergedYamlMapping;
import net.pistonmaster.pistonexploits.PistonExploits;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStream;
import java.nio.file.Files;

/** Reads, writes and upgrades configs! */
@SuppressWarnings("unused")
public class ConfigManager {
  private final PistonExploits plugin;
  private MergedYamlMapping mergedYamlMapping;

  public ConfigManager(PistonExploits plugin) {
    this.plugin = plugin;
  }

  public void create() throws IOException {
    createIfAbsent();

    mergedYamlMapping = new MergedYamlMapping(getConfig(), getDefaultConfig());

    saveConfig(mergedYamlMapping);

    plugin.reloadConfig();
  }

  private YamlMapping getDefaultConfig() throws IOException {
    return Yaml.createYamlInput(getDefaultInput()).readYamlMapping();
  }

  private YamlMapping getConfig() throws IOException {
    return Yaml.createYamlInput(getConfigFile()).readYamlMapping();
  }

  private void saveConfig(YamlMapping mapping) throws IOException {
    Yaml.createYamlPrinter(new FileWriter(getConfigFile())).print(mapping);
  }

  private void createIfAbsent() throws IOException {
    File configFile = getConfigFile();

    if (!plugin.getDataFolder().exists() && !plugin.getDataFolder().mkdir()) {
      throw new IOException("Could not create data folder!");
    }

    if (!configFile.exists()) {
      Files.copy(getDefaultInput(), configFile.toPath());
    }
  }

  private File getConfigFile() {
    return new File(plugin.getDataFolder(), "config.yml");
  }

  private InputStream getDefaultInput() {
    return plugin.getResource("config.yml");
  }
}
