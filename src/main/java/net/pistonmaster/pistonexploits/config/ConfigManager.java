package net.pistonmaster.pistonexploits.config;

import com.amihaiemil.eoyaml.Yaml;
import com.amihaiemil.eoyaml.YamlMapping;
import com.amihaiemil.eoyaml.extensions.MergedYamlMapping;
import net.pistonmaster.pistonexploits.PistonExploits;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStream;
import java.nio.file.Files;

public class ConfigManager {
    private final PistonExploits plugin;
    private MergedYamlMapping mergedYamlMapping;

    public ConfigManager(PistonExploits plugin) {
        this.plugin = plugin;
    }

    public void create() throws IOException {
        createIfAbsent();

        mergedYamlMapping = new MergedYamlMapping(getConfig(), getDefaultConfig());

        saveConfig(mergedYamlMapping);
    }

    public YamlMapping getMapping() {
        return mergedYamlMapping;
    }

    private YamlMapping getDefaultConfig() throws IOException {
        return Yaml.createYamlInput(getDefaultInput()).readYamlMapping();
    }

    private YamlMapping getConfig() throws IOException {
        return Yaml.createYamlInput(getConfigFile()).readYamlMapping();
    }

    private void saveConfig(YamlMapping mapping) throws IOException {
        Yaml.createYamlPrinter(new FileWriter(getConfigFile())).print(mapping);
    }

    private void createIfAbsent() throws IOException {
        File configFile = getConfigFile();

        if (!plugin.getDataFolder().exists() && !plugin.getDataFolder().mkdir()) {
            throw new IOException("Could not create data folder!");
        }

        if (!configFile.exists()) {
            Files.copy(getDefaultInput(), configFile.toPath());
        }
    }

    private File getConfigFile() {
        return new File(plugin.getDataFolder(), "config.yml");
    }

    private InputStream getDefaultInput() {
        return plugin.getResource("config.yml");
    }
}
