package net.pistonmaster.pistonexploits.lagpatches;

import net.pistonmaster.pistonexploits.PistonExploits;
import org.bukkit.configuration.ConfigurationSection;
import org.bukkit.entity.Entity;
import org.bukkit.entity.EntityType;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.world.ChunkUnloadEvent;

import java.util.EnumMap;
import java.util.Map;
import java.util.Set;

/**
 * Wither skulls, withers, etc. = lag on load of the chunk. We just remove them when the chunk is
 * unloading so people don't wait for their chunk to load long.
 */
public class EntityRemover implements Listener {
  private final PistonExploits plugin;

  public EntityRemover(PistonExploits plugin) {
    this.plugin = plugin;
  }

  @EventHandler(priority = EventPriority.LOW)
  public void onChunkLoad(ChunkUnloadEvent event) {
    Map<EntityType, Integer> entities = new EnumMap<>(EntityType.class);
    ConfigurationSection section =
        plugin.getConfig().getConfigurationSection("antilag.entityremover");
    Set<String> keys = section.getKeys(false);

    for (Entity entity : event.getChunk().getEntities()) {
      if (keys.contains(entity.getType().toString()))
        entities.computeIfPresent(
            entity.getType(),
            (type, amount) -> {
              if (amount > section.getInt(entity.getType().toString())) {
                entity.remove();
                return amount;
              } else {
                return amount + 1;
              }
            });
    }
  }
}
